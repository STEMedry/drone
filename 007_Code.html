<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Code Simulation</title>
<style>
body {
  font-family: Arial, sans-serif;
  display: flex; flex-direction: column; align-items: center;
  padding: 5px; margin: 3px; background: #f0f0f0;
}
h2[data-translate="title"] { margin: 5px 0; }
p[data-translate="instruction"] { margin: 2px 0 5px; }
#game-container {
  display: flex; gap: 5px; margin-bottom: 5px; height: 600px;
}
#obstacle-course {
  width: 800px; height: 600px; border: 2px solid #000; background: #fff;
}
#code-area {
  width: 400px; border: 2px solid #000; padding: 10px; background: #fff;
  overflow: auto; position: relative;
}
#command-buttons { display: flex; flex-direction: column; gap: 10px; margin-bottom: 5px; }
.button-row { display: flex; align-items: center; gap: 5px; }
.button-row input, .button-row select { padding: 3px; }
.button-row input { width: 60px; }
button {
  padding: 5px; font-size: 12px; color: white; border: none;
  border-radius: 3px; cursor: pointer;
}
.green-button { background: #4CAF50; }
.orange-button { background: #FFA500; }
.blue-button { background: #0000FF; }
#run-button,#reset-button,#path-preview-button,#centre-button {
  margin-top: 10px; padding: 10px; font-size: 16px;
}
#run-button { background: #FF0000; }
#reset-button { background: #FFC0CB; }
#path-preview-button { background: #0000FF; }
#centre-button { background: #008CBA; }
#help-button, #game-button {
  position: absolute; top: 10px; background: #6A5ACD; color: white;
  border: none; border-radius: 3px; cursor: pointer;
}
#help-button { right: 10px; padding: 5px 14px; font-size: 14px; }
#game-button { right: 90px; padding: 5px 12px; font-size: 14px; }
#code-input { width: 95%; height: 200px; resize: vertical; }
#message { margin-top: 5px; font-weight: bold; min-height: 10px; text-align: left; }
#view-controls { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
#view-controls button {
  border: 2px solid #8B4513; background: white; color: #8B4513;
  font-size: 16px; font-weight: bold; cursor: pointer;
}
#language-switch {
  position: fixed; top: 10px; right: 180px;
  padding: 5px 10px; background: #4CAF50; color: white;
  border: none; border-radius: 3px; cursor: pointer;
}
.modal {
  display: none; position: fixed; z-index: 1000;
  left: 0; top: 0; width: 100%; height: 100%;
  overflow: auto; background: rgba(0,0,0,0.4);
}
.modal-content {
  background: #fefefe; margin: 5% auto; padding: 20px;
  border: 1px solid #888; width: 80%; max-width: 600px;
  border-radius: 8px;
}
.close {
  float: right; font-size: 28px; font-weight: bold; color: #aaa;
  cursor: pointer;
}
.close:hover { color: black; }
.modal-header { display: flex; justify-content: space-between; align-items: center; }
.modal-body { margin-top: 10px; white-space: pre-wrap; }
.modal-footer { margin-top: 20px; text-align: right; }
.button { margin: 5px; padding: 8px 16px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; }
.next-button, .prev-button { background: #008CBA; color: white; }
.close-button { background: #f44336; color: white; }
@keyframes blink { 0%,100%{opacity:1}50%{opacity:0;} }
.blink { animation: blink 1s infinite; }
@keyframes colorChange { 0%{color:red}33%{color:green}66%{color:blue}100%{color:red} }
.color-change { animation: colorChange 3s infinite; }
</style>
</head>
<body>
  <button id="language-switch" onclick="toggleLanguage()">繁體中文</button>
  <h2 data-translate="title">Code Performance Simulation</h2>
  <p data-translate="instruction">
    Use the blocks to create a flight path for the drone, then click 'Run / Pause' to execute the instructions.
  </p>

  <div id="game-container">
    <div style="display:flex;flex-direction:column;align-items:flex-start;">
      <div id="obstacle-course"></div>
    </div>
    <div id="code-area">
      <button id="help-button" onclick="openTutorial()" data-translate="helpButton">Tutorial</button>
      <button id="game-button" onclick="window.location.href='05_Code_Game.html'">Game</button>
      <div id="command-buttons">
        <!-- Original blocks -->
        <div class="button-row">
          <button class="green-button" onclick="addCommand('takeOff')" data-translate="takeOff">Take Off</button>
          <button class="green-button" onclick="addCommand('land')" data-translate="land">Land</button>
        </div>
        <div class="button-row">
          <button class="green-button" onclick="addCommand('throttleUp')" data-translate="throttleUp">Throttle Up</button>
          <input type="text" id="throttle-distance-up" placeholder="value/var">
          <button class="green-button" onclick="addCommand('throttleDown')" data-translate="throttleDown">Throttle Down</button>
          <input type="text" id="throttle-distance-down" placeholder="value/var">
        </div>
        <div class="button-row">
          <button class="green-button" onclick="addCommand('yawLeft')" data-translate="yawLeft">Yaw Left</button>
          <input type="text" id="yaw-angle" placeholder="value/var">
          <button class="green-button" onclick="addCommand('yawRight')" data-translate="yawRight">Yaw Right</button>
          <input type="text" id="yaw-angle-right" placeholder="value/var">
        </div>
        <div class="button-row">
          <button class="orange-button" onclick="addCommand('pitchForward')" data-translate="pitchForward">Pitch Forward</button>
          <input type="text" id="pitch-distance" placeholder="value/var">
          <button class="orange-button" onclick="addCommand('pitchBackward')" data-translate="pitchBackward">Pitch Backward</button>
          <input type="text" id="pitch-distance-back" placeholder="value/var">
        </div>
        <div class="button-row">
          <button class="orange-button" onclick="addCommand('rollLeft')" data-translate="rollLeft">Roll Left</button>
          <input type="text" id="roll-distance" placeholder="value/var">
          <button class="orange-button" onclick="addCommand('rollRight')" data-translate="rollRight">Roll Right</button>
          <input type="text" id="roll-distance-right" placeholder="value/var">
        </div>
        <div class="button-row">
          <button class="blue-button" onclick="addCommand('repeat')" data-translate="repeat">Repeat</button>
          <input type="text" id="repeat-times" placeholder="number or variable">
          <button class="blue-button" onclick="addCommand('setVariable')" data-translate="setVariable">Set</button>
          <input type="text" id="var-name" placeholder="variable name">
          <span>to</span>
          <input type="text" id="var-value" placeholder="value">
        </div>
        <!-- UPDATED: If... then -->
        <div class="button-row">
          <button class="blue-button" onclick="addCommand('ifThen')" data-translate="ifThen">If... then</button>
          <input type="text" id="if-condition" placeholder="condition">
          <span>then</span>
          <input type="text" id="if-then-action" placeholder="action">
        </div>
        <!-- UPDATED: If... then... else -->
        <div class="button-row">
          <button class="blue-button" onclick="addCommand('ifThenElse')" data-translate="ifThenElse">If... then... else</button>
          <input type="text" id="if-condition-else" placeholder="condition">
          <span>then</span>
          <input type="text" id="if-then-action-else" placeholder="action">
          <span>else</span>
          <input type="text" id="if-else-action" placeholder="action">
        </div>
        <!-- New XYZ increase -->
        <div class="button-row">
          <button class="blue-button" onclick="addCommand('xyzIncrease')" data-translate="xyzIncrease">XYZ increase</button>
          <input type="text" id="xyz-x" placeholder="x">
          <input type="text" id="xyz-y" placeholder="y">
          <input type="text" id="xyz-z" placeholder="z">
        </div>
      </div>
      <textarea id="code-input"></textarea><br>
      <div class="button-row">
        <button id="run-button" onclick="runCode()" data-translate="runPauseCode">Run / Pause</button>
        <button id="reset-button" onclick="resetSimulation()" data-translate="reset">Reset</button>
        <button id="path-preview-button" onclick="previewPath()" data-translate="pathPreview">Path Preview</button>
        <button id="centre-button" onclick="centreView()" data-translate="centre">Centre</button>
      </div>
    </div>
  </div>
  <div id="message"></div>
  <div id="view-controls">
    <button onclick="rotateView('left')" data-translate="rotateLeft">Rotate Left</button>
    <button onclick="rotateView('right')" data-translate="rotateRight">Rotate Right</button>
    <button onclick="moveViewUp()" data-translate="up">Up</button>
    <button onclick="moveViewDown()" data-translate="down">Down</button>
    <button onclick="zoom('in')" data-translate="zoomIn">Zoom In</button>
    <button onclick="zoom('out')" data-translate="zoomOut">Zoom Out</button>
    <button onclick="centreView()" data-translate="centre">Centre</button>
  </div>

  <!-- Tutorial Modal unchanged -->
  <div id="tutorial-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 data-translate="tutorialTitle">Tutorial</h2>
        <span class="close" onclick="closeTutorial()">&times;</span>
      </div>
      <div class="modal-body"><div id="tutorial-content"></div></div>
      <div class="modal-footer">
        <button id="prev-button" class="button prev-button" onclick="prevStep()" data-translate="prevButton">Previous</button>
        <button id="next-button" class="button next-button" onclick="nextStep()" data-translate="nextButton">Next</button>
        <button id="close-button" class="button close-button" onclick="closeTutorial()" data-translate="closeButton">Close</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script>
    // ===================================
    // Translations & Language Switch
    // ===================================
    const translations = {
      en: {
        title:"Code Performance Simulation",
        instruction:"Use the blocks to create a flight path for the drone, then click 'Run / Pause' to execute the instructions.",
        takeOff:"Take Off", land:"Land",
        throttleUp:"Throttle Up", throttleDown:"Throttle Down",
        yawLeft:"Yaw Left", yawRight:"Yaw Right",
        pitchForward:"Pitch Forward", pitchBackward:"Pitch Backward",
        rollLeft:"Roll Left", rollRight:"Roll Right",
        repeat:"Repeat", setVariable:"Set",
        ifThen:"If... then", ifThenElse:"If... then... else",
        xyzIncrease:"XYZ increase", xyzIncreaseAlert:"Please enter values for X, Y, and Z.",
        runPauseCode:"Run / Pause", runPauseCodeRunning:"Pause", runPauseCodePaused:"Resume",
        reset:"Reset", pathPreview:"Path Preview", centre:"Centre",
        helpButton:"Tutorial", rotateLeft:"Rotate Left", rotateRight:"Rotate Right",
        up:"Up", down:"Down", zoomIn:"Zoom In", zoomOut:"Zoom Out",
        tutorialTitle:"Tutorial",
        tutorialStep1Title:"Welcome!", tutorialStep1Content:"Welcome to the Code Performance Simulation. This tutorial will guide you through the basics of creating and running your drone's flight path.",
        tutorialStep2Title:"Learning Objectives", tutorialStep2Content:"• Understand how to use command blocks to control the drone.\n• Learn to write and execute simple code.\n• Experience iterative code refinement for autonomous navigation.",
        tutorialStep3Title:"Creating a Flight Path", tutorialStep3Content:"1. Use the command buttons to add actions like Take Off, Move, Yaw, etc.\n2. Specify parameters in the input fields.\n3. Each command will be added to your code area.",
        tutorialStep4Title:"Running Your Code", tutorialStep4Content:"After setting up your flight path, click the 'Run / Pause' button to execute the instructions and see your drone navigate the path.",
        tutorialStep5Title:"Previewing the Path", tutorialStep5Content:"Use the 'Path Preview' button to visualize the entire flight path before running the code.",
        tutorialStep6Title:"Resetting the Simulation", tutorialStep6Content:"If you want to start over, click the 'Reset' button to clear your code and reset the drone's position.",
        tutorialStep7Title:"Getting Help", tutorialStep7Content:"At any time, you can click the 'Tutorial' button to revisit this tutorial.",
        nextButton:"Next", prevButton:"Previous", closeButton:"Close",
        takingOff:"Taking off...", landing:"Landing...", simulationReset:"Simulation reset. Drone restored to default position and orientation.",
        noValidCommands:"No valid commands to preview the path.", invalidCodeStructure:"The code must start with 'Take Off' and end with 'Land'.",
        throttleUpAlert:"Please enter a value or variable for Throttle Up.", throttleDownAlert:"Please enter a value or variable for Throttle Down.",
        yawLeftAlert:"Please enter a value or variable for Yaw Left.", yawRightAlert:"Please enter a value or variable for Yaw Right.",
        pitchForwardAlert:"Please enter a value or variable for Pitch Forward.", pitchBackwardAlert:"Please enter a value or variable for Pitch Backward.",
        rollLeftAlert:"Please enter a value or variable for Roll Left.", rollRightAlert:"Please enter a value or variable for Roll Right.",
        pitchForwardMinAlert:"Please enter a value of at least 10 for Pitch Forward.", pitchBackwardMinAlert:"Please enter a value of at least 10 for Pitch Backward.",
        rollLeftMinAlert:"Please enter a value of at least 10 for Roll Left.", rollRightMinAlert:"Please enter a value of at least 10 for Roll Right.",
        repeatAlert:"Please enter the number of times or a variable name to repeat.", setVariableAlert:"Please enter both variable name and value.",
        ifThenAlert:"Please enter a condition for If... then.", ifThenElseAlert:"Please enter a condition for If... then... else."
      },
      zh: {
        title:"編程表現模擬", instruction:"使用方塊創建無人機的飛行路徑，然後點擊「執行 / 暫停」以執行指令。",
        takeOff:"起飛", land:"著陸",
        throttleUp:"上升", throttleDown:"下降",
        yawLeft:"左偏航", yawRight:"右偏航",
        pitchForward:"前俯仰", pitchBackward:"後俯仰",
        rollLeft:"左滾轉", rollRight:"右滾轉",
        repeat:"重複", setVariable:"設置",
        ifThen:"如果...則", ifThenElse:"如果...則...否則",
        xyzIncrease:"XYZ 增加", xyzIncreaseAlert:"請為 X、Y、Z 輸入值。",
        runPauseCode:"執行 / 暫停", runPauseCodeRunning:"暫停", runPauseCodePaused:"繼續",
        reset:"重置", pathPreview:"路徑預覽", centre:"居中",
        helpButton:"教學", rotateLeft:"向左旋轉", rotateRight:"向右旋轉",
        up:"向上", down:"向下", zoomIn:"放大", zoomOut:"縮小",
        tutorialTitle:"教學",
        tutorialStep1Title:"歡迎！", tutorialStep1Content:"歡迎來到編程表現模擬。這個教學將指導你創建和運行無人機的飛行路徑的基礎知識。",
        tutorialStep2Title:"學習目標", tutorialStep2Content:"• 理解如何使用指令方塊來控制無人機。\n• 學習編寫和執行簡單的代碼。\n• 體驗循環代碼優化以實現自主導航。",
        tutorialStep3Title:"創建飛行路徑", tutorialStep3Content:"1. 使用指令按鈕添加起飛、移動、偏航等動作。\n2. 在輸入框中指定參數。\n3. 每個指令都將被添加到你的代碼區域。",
        tutorialStep4Title:"運行你的代碼", tutorialStep4Content:"設置好飛行路徑後，點擊「執行 / 暫停」按鈕執行指令，查看無人機導航路徑。",
        tutorialStep5Title:"預覽路徑", tutorialStep5Content:"使用「路徑預覽」按鈕在運行代碼前可視化整個飛行路徑。",
        tutorialStep6Title:"重置模擬", tutorialStep6Content:"如果你想重新開始，點擊「重置」按鈕清除你的代碼並重置無人機的位置。",
        tutorialStep7Title:"獲取幫助", tutorialStep7Content:"在任何時間，你都可以點擊「教學」按鈕重新訪問這個教學。",
        nextButton:"下一步", prevButton:"上一頁", closeButton:"關閉",
        takingOff:"起飛中...", landing:"著陸中...", simulationReset:"模擬已重置。無人機已恢復到默認位置和方向。",
        noValidCommands:"沒有有效的指令來預覽路徑。", invalidCodeStructure:"代碼必須以「起飛」開始，以「著陸」結束。",
        throttleUpAlert:"請為上升輸入值或變量。", throttleDownAlert:"請為下降輸入值或變量。",
        yawLeftAlert:"請為左偏航輸入值或變量。", yawRightAlert:"請為右偏航輸入值或變量。",
        pitchForwardAlert:"請為前俯仰輸入值或變量。", pitchBackwardAlert:"請為後俯仰輸入值或變量。",
        rollLeftAlert:"請為左滾轉輸入值或變量。", rollRightAlert:"請為右滾轉輸入值或變量。",
        pitchForwardMinAlert:"請為前俯仰輸入至少 10 的值。", pitchBackwardMinAlert:"請為後俯仰輸入至少 10 的值。",
        rollLeftMinAlert:"請為左滾轉輸入至少 10 的值。", rollRightMinAlert:"請為右滾轉輸入至少 10 的值。",
        repeatAlert:"請輸入重複次數或變量名稱。", setVariableAlert:"請同時輸入變量名稱和數值。",
        ifThenAlert:"請為「如果...則」輸入條件。", ifThenElseAlert:"請為「如果...則...否則」輸入條件。"
      }
    };

    let currentLanguage='en';
    function toggleLanguage(){
      currentLanguage = currentLanguage==='en'?'zh':'en';
      updateLanguage();
    }
    function updateLanguage(){
      document.querySelectorAll('[data-translate]').forEach(el=>{
        const key=el.getAttribute('data-translate');
        if(translations[currentLanguage][key]) el.textContent=translations[currentLanguage][key];
      });
      document.getElementById('language-switch').textContent =
        currentLanguage==='en'?'繁體中文':'English';
      if(document.getElementById('tutorial-modal').style.display==='block') populateTutorial();
    }
    function updateRunButton(){
      const btn=document.getElementById('run-button');
      if(!isExecuting) btn.textContent=translations[currentLanguage].runPauseCode;
      else if(isPaused) btn.textContent=translations[currentLanguage].runPauseCodePaused;
      else btn.textContent=translations[currentLanguage].runPauseCodeRunning;
    }

    // Global state & constants
    let isResetPressed=false, isPaused=false, pausePromiseResolver=null,
        isExecuting=false, scene, camera, renderer, drone,
        axesHelper, gridHelper, frontCircles=[], rearCircles=[],
        lastBlinkTime=0, blinkState=true, blinkDuration=500,
        pathLine=null, pathLineBlinkState=true,
        lastPathBlinkToggle=0, pathBlinkInterval=500,
        controls;
    const DEFAULT_DRONE_STATE = {
      position: new THREE.Vector3(0,0,0),
      rotation: new THREE.Euler(0,0,0,'XYZ'),
      scale:    new THREE.Vector3(1,1,1)
    };
    let dronePosition=DEFAULT_DRONE_STATE.position.clone(),
        isThrottling=false, isYawing=false, yawDuration=500,
        pathPositions=[], isPathPreviewShown=false;
    const codeInput=document.getElementById('code-input'),
          messageDiv=document.getElementById('message');

    // Initialization
    function initGame(){
      scene=new THREE.Scene(); scene.background=new THREE.Color(0xf0f0f0);
      renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(800,600);
      const oc=document.getElementById('obstacle-course'); oc.innerHTML=''; oc.appendChild(renderer.domElement);
      camera=new THREE.PerspectiveCamera(75,800/600,0.1,1000);
      camera.position.set(100,70,100); camera.lookAt(dronePosition);
      controls=new THREE.OrbitControls(camera,renderer.domElement);
      controls.enableDamping=true; controls.dampingFactor=0.05;
      scene.add(new THREE.AmbientLight(0xffffff,0.6));
      const dl=new THREE.DirectionalLight(0xffffff,0.8); dl.position.set(10,10,10); scene.add(dl);
      createDrone();
      createCoordinatePlane();
      addDirectionIndicators();
      addWatermark();
      addWatermarkSTEM();
      addVerticalLines();
      axesHelper=new THREE.AxesHelper(100); scene.add(axesHelper);
      animate();
    }

    // Drone & Scene Helpers
    function createDrone(){
      const dg=new THREE.Group();
      const cubeGeom=new THREE.BoxGeometry(15,5,15),
            cubeMat=new THREE.MeshPhongMaterial({color:0x0000ff,transparent:true,opacity:0.5});
      dg.add(new THREE.Mesh(cubeGeom,cubeMat));
      const circleGeom=new THREE.CylinderGeometry(2.25,2.25,0.2,32),
            frontMat=new THREE.MeshBasicMaterial({color:0x00ff00,transparent:true,opacity:1}),
            rearMat=new THREE.MeshBasicMaterial({color:0xff0000,transparent:true,opacity:1});
      [[-7.5,2.6,7.5,frontMat],[7.5,2.6,7.5,frontMat],[-7.5,2.6,-7.5,rearMat],[7.5,2.6,-7.5,rearMat]].forEach((p,i)=>{
        const c=new THREE.Mesh(circleGeom,p[3].clone());
        c.position.set(p[0],p[1],p[2]);
        dg.add(c);
        if(i<2) frontCircles.push(c); else rearCircles.push(c);
      });
      const triGeom=new THREE.ConeGeometry(10,20,3),
            triMat=new THREE.MeshPhongMaterial({color:0xffff00}),
            tri=new THREE.Mesh(triGeom,triMat);
      tri.rotation.x=-Math.PI/2; tri.position.set(0,2.6,-7.5); dg.add(tri);
      dg.position.copy(DEFAULT_DRONE_STATE.position);
      dg.rotation.copy(DEFAULT_DRONE_STATE.rotation);
      dg.scale.copy(DEFAULT_DRONE_STATE.scale);
      scene.add(dg); drone=dg;
    }
    function createCoordinatePlane(){
      const size=200, divisions=20;
      gridHelper=new THREE.GridHelper(size,divisions,0xcccccc,0xcccccc); scene.add(gridHelper);
      const loader=new THREE.FontLoader();
      loader.load('https://threejs.org/examples/fonts/helvetiker_regular.typeface.json',font=>{
        const mat=new THREE.MeshBasicMaterial({color:0x000000});
        for(let i=-100;i<=100;i+=10){
          if(i!==0){
            createText(font,mat,i.toString(),i,0,-100);
            createText(font,mat,(-i).toString(),-100,0,i);
          }
        }
        createText(font,mat,'X',101,0,0);
        createText(font,mat,'Y',0,0,-101);
        createText(font,mat,'Z',0,101,0);
      });
    }
    function createText(font,material,text,x,y,z){
      const geo=new THREE.TextGeometry(text,{font,font,size:5,height:0.5}),
            mesh=new THREE.Mesh(geo,material);
      mesh.position.set(x,y,z); scene.add(mesh);
    }
    function addDirectionIndicators(){
      addDirectionIndicator(new THREE.Vector3(120,0,0),'Right',0xff0000);
      addDirectionIndicator(new THREE.Vector3(-120,0,0),'Left',0xff0000);
      addDirectionIndicator(new THREE.Vector3(0,120,0),'Up',0x00ff00);
      addDirectionIndicator(new THREE.Vector3(0,-120,0),'Down',0x00ff00);
      addDirectionIndicator(new THREE.Vector3(0,0,120),'Rear',0x0000ff);
      addDirectionIndicator(new THREE.Vector3(0,0,-120),'Front',0x0000ff);
    }
    function addDirectionIndicator(position,text,color){
      const canvas=document.createElement('canvas'),
            ctx=canvas.getContext('2d');
      canvas.width=canvas.height=256;
      ctx.fillStyle=`rgb(${(color>>16)&255},${(color>>8)&255},${color&255})`;
      ctx.font='Bold 40px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(text,128,128);
      const texture=new THREE.CanvasTexture(canvas),
            mat=new THREE.SpriteMaterial({map:texture}),
            sprite=new THREE.Sprite(mat);
      sprite.position.copy(position); sprite.scale.set(20,20,20);
      scene.add(sprite);
    }
    function addWatermark(){
      const loader=new THREE.FontLoader();
      loader.load('https://threejs.org/examples/fonts/helvetiker_regular.typeface.json',font=>{
        const mat=new THREE.MeshBasicMaterial({color:0xd3d3d3});
        const geo=new THREE.TextGeometry('EdUHK',{font,font,size:10,height:0.5}),
              mesh=new THREE.Mesh(geo,mat);
        mesh.rotation.x=-Math.PI/2; mesh.position.set(50,0.1,0); scene.add(mesh);
      });
    }
    function addWatermarkSTEM(){
      const loader=new THREE.FontLoader();
      loader.load('https://threejs.org/examples/fonts/helvetiker_regular.typeface.json',font=>{
        const mat=new THREE.MeshBasicMaterial({color:0xd3d3d3});
        const geo=new THREE.TextGeometry('STEM Education',{font,font,size:7,height:0.5}),
              mesh=new THREE.Mesh(geo,mat);
        mesh.rotation.y=Math.PI/2; mesh.position.set(0,0.1,100); scene.add(mesh);
      });
    }
    function addVerticalLines(){
      const mat=new THREE.LineBasicMaterial({color:0xcccccc});
      for(let y=20;y<=100;y+=20){
        const pts=[
          new THREE.Vector3(-100,y,-100),
          new THREE.Vector3(100,y,-100),
          new THREE.Vector3(100,y,100),
          new THREE.Vector3(-100,y,100),
          new THREE.Vector3(-100,y,-100)
        ];
        const geo=new THREE.BufferGeometry().setFromPoints(pts),
              line=new THREE.Line(geo,mat);
        scene.add(line);
      }
    }

    // Animation Loop
    function animate(){
      requestAnimationFrame(animate);
      const now=Date.now();
      if(now - lastBlinkTime > blinkDuration){
        blinkState=!blinkState; lastBlinkTime=now;
        frontCircles.forEach(c=>c.material.opacity=blinkState?1:0);
        rearCircles.forEach(c=>c.material.opacity=blinkState?1:0);
      }
      if(pathLine && now - lastPathBlinkToggle > pathBlinkInterval){
        pathLine.visible=pathLineBlinkState;
        pathLineBlinkState=!pathLineBlinkState;
        lastPathBlinkToggle=now;
      }
      controls.update();
      renderer.render(scene,camera);
    }

    // Command Insertion
    function addCommand(commandType){
      let command='', parameter='';
      const getVal=id=>document.getElementById(id).value.trim()||null;
      const isNum=v=>!isNaN(parseFloat(v))&&isFinite(v);

      switch(commandType){
        case 'takeOff': command='takeOff'; break;
        case 'land':    command='land';    break;
        case 'throttleUp':
          parameter=getVal('throttle-distance-up');
          if(!parameter){ alert(translations[currentLanguage].throttleUpAlert); return;}
          command=`throttleUp ${parameter}`; break;
        case 'throttleDown':
          parameter=getVal('throttle-distance-down');
          if(!parameter){ alert(translations[currentLanguage].throttleDownAlert); return;}
          command=`throttleDown ${parameter}`; break;
        case 'yawLeft':
          parameter=getVal('yaw-angle');
          if(!parameter){ alert(translations[currentLanguage].yawLeftAlert); return;}
          command=`yawLeft ${parameter}`; break;
        case 'yawRight':
          parameter=getVal('yaw-angle-right');
          if(!parameter){ alert(translations[currentLanguage].yawRightAlert); return;}
          command=`yawRight ${parameter}`; break;
        case 'pitchForward':
          parameter=getVal('pitch-distance');
          if(!parameter){ alert(translations[currentLanguage].pitchForwardAlert); return;}
          if(isNum(parameter)&&parseFloat(parameter)<10){ alert(translations[currentLanguage].pitchForwardMinAlert); return;}
          command=`pitchForward ${parameter}`; break;
        case 'pitchBackward':
          parameter=getVal('pitch-distance-back');
          if(!parameter){ alert(translations[currentLanguage].pitchBackwardAlert); return;}
          if(isNum(parameter)&&parseFloat(parameter)<10){ alert(translations[currentLanguage].pitchBackwardMinAlert); return;}
          command=`pitchBackward ${parameter}`; break;
        case 'rollLeft':
          parameter=getVal('roll-distance');
          if(!parameter){ alert(translations[currentLanguage].rollLeftAlert); return;}
          if(isNum(parameter)&&parseFloat(parameter)<10){ alert(translations[currentLanguage].rollLeftMinAlert); return;}
          command=`rollLeft ${parameter}`; break;
        case 'rollRight':
          parameter=getVal('roll-distance-right');
          if(!parameter){ alert(translations[currentLanguage].rollRightAlert); return;}
          if(isNum(parameter)&&parseFloat(parameter)<10){ alert(translations[currentLanguage].rollRightMinAlert); return;}
          command=`rollRight ${parameter}`; break;
        case 'repeat':
          parameter=getVal('repeat-times');
          if(!parameter){ alert(translations[currentLanguage].repeatAlert); return;}
          command=`repeat ${parameter} times\n{\n\n}`; break;
        case 'setVariable':
          const vn=getVal('var-name'), vv=getVal('var-value');
          if(!vn||!vv){ alert(translations[currentLanguage].setVariableAlert); return;}
          command=`set ${vn} to ${vv}`; break;
        case 'ifThen': {
          const cond=getVal('if-condition'),
                act=getVal('if-then-action');
          if(!cond){ alert(translations[currentLanguage].ifThenAlert); return; }
          if(!act){ alert("Please enter an action for 'then'."); return; }
          command=
            `if ${cond} then\n`+
            `{\n  ${act}\n}`;
          break;
        }
        case 'ifThenElse': {
          const cond=getVal('if-condition-else'),
                thenAct=getVal('if-then-action-else'),
                elseAct=getVal('if-else-action');
          if(!cond){ alert(translations[currentLanguage].ifThenElseAlert); return; }
          if(!thenAct){ alert("Please enter an action for 'then'."); return; }
          if(!elseAct){ alert("Please enter an action for 'else'."); return; }
          command=
            `if ${cond} then\n`+
            `{\n  ${thenAct}\n}\n`+
            `else\n`+
            `{\n  ${elseAct}\n}`;
          break;
        }
        case 'xyzIncrease':
          const x=getVal('xyz-x'), y=getVal('xyz-y'), z=getVal('xyz-z');
          if(!x||!y||!z){ alert(translations[currentLanguage].xyzIncreaseAlert); return;}
          command=`xyzIncrease ${x} ${y} ${z}`; break;
        default:
          console.warn(`Unknown command type: ${commandType}`); return;
      }
      addCommandAtCursor(command);
    }
    function addCommandAtCursor(command){
      const start=codeInput.selectionStart, end=codeInput.selectionEnd,
            before=codeInput.value.slice(0,start), after=codeInput.value.slice(end);
      codeInput.value = before + command + '\n' + after;
      const pos = start + command.length + 1;
      codeInput.selectionStart = codeInput.selectionEnd = pos;
      codeInput.focus();
    }

    // Parsing & Execution
    function parseCode(code){
      const lines=code.split('\n'), commands=[], stack=[];
      function procLine(line){
        if(line.startsWith('set ')){
          const m=line.match(/set (\w+)\s*(?:=|to)\s*(.+)/);
          if(m) return {type:'set',varName:m[1],expression:m[2]};
          console.warn(`Invalid set: ${line}`); return null;
        }
        if(line.match(/^repeat\s+(.+)\s+times$/i)){
          const m=line.match(/^repeat\s+(.+)\s+times$/i);
          return {type:'repeat',countExpression:m[1],commands:[]};
        }
        if(line.match(/^if\s+(.+)\s+then$/i)){
          const m=line.match(/^if\s+(.+)\s+then$/i);
          return {type:'if',condition:m[1],thenCommands:[],elseCommands:[],inElse:false};
        }
        if(line==='else') return {type:'else'};
        if(line==='}') return {type:'end-block'};
        return {type:'command',value:line};
      }
      for(const raw of lines){
        const line=raw.trim(); if(!line) continue;
        const p=procLine(line); if(!p) continue;
        if(p.type==='repeat'||p.type==='if') stack.push(p);
        else if(p.type==='else'){
          if(stack.length&&stack[stack.length-1].type==='if') stack[stack.length-1].inElse=true;
          else console.warn('Unexpected else');
        } else if(p.type==='end-block'){
          const block=stack.pop(); if(!block){ console.warn('Unexpected }'); continue; }
          let completed;
          if(block.type==='repeat') completed={type:'repeat',countExpression:block.countExpression,commands:block.commands};
          else completed={type:'if',condition:block.condition,thenCommands:block.thenCommands,elseCommands:block.elseCommands};
          if(stack.length){
            const parent=stack[stack.length-1];
            if(parent.type==='repeat') parent.commands.push(completed);
            else if(parent.type==='if'){
              if(!parent.inElse) parent.thenCommands.push(completed);
              else parent.elseCommands.push(completed);
            }
          } else commands.push(completed);
        } else if(stack.length){
          const parent=stack[stack.length-1];
          if(parent.type==='repeat') parent.commands.push(p);
          else if(parent.type==='if'){
            if(!parent.inElse) parent.thenCommands.push(p);
            else parent.elseCommands.push(p);
          }
        } else commands.push(p);
      }
      return commands;
    }
    function evaluateExpression(expr,vars){
      try{ return Function(...Object.keys(vars),`return ${expr}`)(...Object.values(vars)); }
      catch(e){ console.error(`Error eval: "${expr}"`,e); return 0; }
    }
    function executeCommands(cmds){
      const vars={}, final=[];
      function exec(c){
        if(c.type==='set') vars[c.varName]=evaluateExpression(c.expression,vars);
        else if(c.type==='repeat'){
          let cnt=evaluateExpression(c.countExpression,vars);
          if(isNaN(cnt)||cnt<=0) cnt=1; cnt=Math.round(cnt);
          for(let i=0;i<cnt;i++) c.commands.forEach(exec);
        }
        else if(c.type==='if'){
          const cond=evaluateExpression(c.condition,vars);
          (cond?c.thenCommands:c.elseCommands).forEach(exec);
        }
        else if(c.type==='command'){
          const parts=c.value.split(' ');
          if(parts[0].startsWith('//')) return;
          const ep=parts.map((p,i)=>i>0?evaluateExpression(p,vars):p);
          final.push(ep.join(' '));
        }
      }
      cmds.forEach(exec);
      return final;
    }

    // Runtime Execution
    async function runCode(){
      if(isExecuting){
        isPaused=!isPaused;
        if(!isPaused&&pausePromiseResolver){ pausePromiseResolver(); pausePromiseResolver=null; }
        updateRunButton(); return;
      }

      // Reset to origin
      dronePosition.copy(DEFAULT_DRONE_STATE.position);
      drone.position.copy(DEFAULT_DRONE_STATE.position);
      drone.rotation.copy(DEFAULT_DRONE_STATE.rotation);
      controls.target.copy(DEFAULT_DRONE_STATE.position);
      controls.update();

      const parsed=parseCode(codeInput.value), flat=executeCommands(parsed);
      if(flat.length<2||flat[0].trim().toLowerCase()!=='takeoff'||flat[flat.length-1].trim().toLowerCase()!=='land'){
        alert(translations[currentLanguage].invalidCodeStructure); return;
      }

      isExecuting=true; isPaused=false; updateRunButton();
      for(const cmd of flat){
        if(isResetPressed){ isResetPressed=false; break; }
        await executeSingleCommand(cmd);
        if(isPaused) await new Promise(r=>pausePromiseResolver=r);
      }
      isExecuting=false; updateRunButton();
    }

    function executeSingleCommand(command){
      return new Promise(resolve=>{
        if(isResetPressed){ resolve(); return; }
        const parts=command.split(' '), base=parts[0].toLowerCase(), param=parts[1]?parseFloat(parts[1]):null;

        if(base==='xyzincrease'){
          const x=parseFloat(parts[1]), y=parseFloat(parts[2]), z=parseFloat(parts[3]);
          xyzIncreaseDrone(x,z,-y).then(resolve); return;
        }

        switch(base){
          case 'takeoff': throttleDrone('up',20).then(resolve); break;
          case 'land':    throttleDrone('down',dronePosition.y).then(resolve); break;
          case 'pitchforward': case 'pitchbackward':
          case 'rollleft':      case 'rollright':
          case 'throttleup':    case 'throttledown':
          case 'yawleft':       case 'yawright':
            if(param!==null){
              const m=base.match(/(pitch|roll|throttle|yaw)(left|right|forward|backward|up|down)?/);
              if(m){
                const act=m[1], dir=m[2];
                if(act==='pitch')    pitchDrone(dir,param).then(resolve);
                else if(act==='roll')rollDrone(dir,param).then(resolve);
                else if(act==='throttle')throttleDrone(dir,param).then(resolve);
                else if(act==='yaw') yawDrone(dir,param).then(resolve);
                else resolve();
              } else resolve();
            } else resolve();
            break;
          case 'set': console.log(`Setting variable: ${command}`); resolve(); break;
          default: console.warn(`Unknown command: ${command}`); resolve(); break;
        }
      });
    }

    // Motion Primitives
    function pitchDrone(direction, distance){
      return new Promise(resolve=>{
        const steps=20, stepDur=50;
        let i=0, dz=(distance/steps)*(direction==='forward'? -1:1);
        const iv=setInterval(()=>{
          if(i<steps){ moveDrone(0,0,dz); i++; }
          else{ clearInterval(iv); resolve(); }
        },stepDur);
      });
    }
    function rollDrone(direction, distance){
      return new Promise(resolve=>{
        const steps=20, stepDur=50;
        let i=0, dx=(distance/steps)*(direction==='left'? -1:1);
        const iv=setInterval(()=>{
          if(i<steps){ moveDrone(dx,0,0); i++; }
          else{ clearInterval(iv); resolve(); }
        },stepDur);
      });
    }
    function throttleDrone(direction, distance){
      return new Promise(resolve=>{
        if(isThrottling){ resolve(); return; }
        isThrottling=true;
        const steps=20, stepDur=1000/steps;
        let i=0, dy=(direction==='up'? distance/steps : -distance/steps);
        const iv=setInterval(()=>{
          if(i<steps){ moveDrone(0,dy,0); i++; }
          else{ clearInterval(iv); isThrottling=false; resolve(); }
        },stepDur);
      });
    }
    function yawDrone(direction, angle){
      return new Promise(resolve=>{
        if(isYawing){ resolve(); return; }
        isYawing=true;
        const steps=30, stepDur=yawDuration/steps;
        let i=0, dA=((angle*Math.PI/180)/steps)*(direction==='left'?1:-1);
        const iv=setInterval(()=>{
          if(i<steps){ drone.rotation.y += dA; i++; }
          else{ clearInterval(iv); isYawing=false; resolve(); }
        },stepDur);
      });
    }
    function moveDrone(x,y,z){
      const mv=new THREE.Vector3(x,y,z).applyEuler(drone.rotation);
      dronePosition.add(mv);
      drone.position.copy(dronePosition);
    }
    function xyzIncreaseDrone(dx,dy,dz){
      return new Promise(resolve=>{
        const steps=20, stepDur=50;
        const sx=dx/steps, sy=dy/steps, sz=dz/steps;
        let i=0;
        const iv=setInterval(()=>{
          if(i<steps){ moveDrone(sx,sy,sz); i++; }
          else{ clearInterval(iv); resolve(); }
        },stepDur);
      });
    }

    // Reset & View Controls
    function resetSimulation(){
      isResetPressed=true; isPaused=false; isExecuting=false;
      Object.values({}).forEach(clearInterval);
      dronePosition=DEFAULT_DRONE_STATE.position.clone();
      drone.position.copy(dronePosition);
      drone.rotation.copy(DEFAULT_DRONE_STATE.rotation);
      camera.position.set(100,70,100); camera.lookAt(dronePosition);
      controls.target.copy(dronePosition); controls.update();
      messageDiv.textContent=''; messageDiv.classList.remove('blink','color-change');
      if(pathLine){ scene.remove(pathLine); pathLine=null; isPathPreviewShown=false; }
      if(gridHelper){ scene.remove(gridHelper); }
      gridHelper=new THREE.GridHelper(200,20,0xcccccc,0xcccccc); scene.add(gridHelper);
      isThrottling=false; isYawing=false; pathPositions=[];
      updateRunButton(); renderer.render(scene,camera);
      console.log(translations[currentLanguage].simulationReset);
    }
    function rotateView(direction){
      const angle=direction==='left'?Math.PI/18:-Math.PI/18;
      const cp=camera.position.clone().sub(dronePosition);
      cp.applyAxisAngle(new THREE.Vector3(0,1,0),angle);
      camera.position.copy(dronePosition).add(cp);
      camera.lookAt(dronePosition);
    }
    function moveViewUp(){ camera.position.y+=10; camera.lookAt(dronePosition); }
    function moveViewDown(){ if(camera.position.y>10){ camera.position.y-=10; camera.lookAt(dronePosition); }}
    function zoom(direction){
      const factor=direction==='in'?0.9:1.1;
      const cp=camera.position.clone().sub(dronePosition).multiplyScalar(factor);
      camera.position.copy(dronePosition).add(cp); camera.lookAt(dronePosition);
    }
    function centreView(){
      camera.position.set(100,70,100); camera.lookAt(dronePosition);
      controls.target.copy(dronePosition); controls.update();
    }

    // Path Preview
    function previewPath(){
      if(isPathPreviewShown){
        if(pathLine){ scene.remove(pathLine); pathLine=null; }
        isPathPreviewShown=false; return;
      }
      const parsed=parseCode(codeInput.value), flat=executeCommands(parsed);
      let pos=new THREE.Vector3(0,20,0), rot=new THREE.Euler(0,0,0,'YXZ'),
          pts=[new THREE.Vector3(0,0,0),pos.clone()],
          minX=0,maxX=0,minY=0,maxY=20,minZ=0,maxZ=0;
      flat.forEach(c=>{
        const parts=c.split(' '), b=parts[0].toLowerCase(), p=parts[1]?parseFloat(parts[1]):null;
        if(b==='xyzincrease'){
          const dx=parseFloat(parts[1]), 
                dy=parseFloat(parts[2]), 
                dz=parseFloat(parts[3]);
          pos.x+=dx; 
          pos.z-=dy; 
          pos.y+=dz;
        }
        else if(p!==null){
          if(b==='throttleup') pos.y+=p;
          if(b==='throttledown') pos.y=Math.max(0,pos.y-p);
          if(b==='yawleft') rot.y+=THREE.MathUtils.degToRad(p);
          if(b==='yawright') rot.y-=THREE.MathUtils.degToRad(p);
          if(b==='pitchforward'||b==='pitchbackward'){
            const d=(b==='pitchforward'? -p:p),
                  f=new THREE.Vector3(0,0,d).applyEuler(rot);
            pos.add(f);
          }
          if(b==='rollleft'||b==='rollright'){
            const d=(b==='rollleft'? -p:p),
                  s=new THREE.Vector3(d,0,0).applyEuler(rot);
            pos.add(s);
          }
        }
        if(b!=='takeoff'&&b!=='land'){
          pts.push(pos.clone());
          minX=Math.min(minX,pos.x); maxX=Math.max(maxX,pos.x);
          minY=Math.min(minY,pos.y); maxY=Math.max(maxY,pos.y);
          minZ=Math.min(minZ,pos.z); maxZ=Math.max(maxZ,pos.z);
        }
      });
      pts.push(new THREE.Vector3(pos.x,0,pos.z));
      if(pts.length<2){ alert(translations[currentLanguage].noValidCommands); return; }
      const geo=new THREE.BufferGeometry().setFromPoints(pts),
            mat=new THREE.LineBasicMaterial({color:0x0000ff,linewidth:2});
      pathLine=new THREE.Line(geo,mat); scene.add(pathLine); isPathPreviewShown=true;
      const padding=50, sizeX=maxX-minX, sizeZ=maxZ-minZ,
            maxSize=Math.max(sizeX,sizeZ,100),
            gridSize=Math.ceil((maxSize+padding)*1.2);
      if(gridHelper) scene.remove(gridHelper);
      gridHelper=new THREE.GridHelper(gridSize,gridSize/10,0xcccccc,0xcccccc);
      scene.add(gridHelper);
      const centerX=(minX+maxX)/2, centerZ=(minZ+maxZ)/2;
      camera.position.set(centerX+gridSize/2,gridSize/2,centerZ+gridSize/2);
      camera.lookAt(new THREE.Vector3(centerX,0,centerZ));
      controls.target.set(centerX,0,centerZ); controls.update();
      renderer.render(scene,camera);
    }

    // Tutorial Modal
    const tutorialModal=document.getElementById("tutorial-modal"),
          tutorialContent=document.getElementById("tutorial-content");
    let currentStep=1, totalSteps=7;
    function openTutorial(){ currentStep=1; populateTutorial(); tutorialModal.style.display="block"; }
    function closeTutorial(){ tutorialModal.style.display="none"; }
    function nextStep(){ if(currentStep<totalSteps){ currentStep++; populateTutorial(); } }
    function prevStep(){ if(currentStep>1){ currentStep--; populateTutorial(); } }
    function populateTutorial(){
      const c=translations[currentLanguage];
      let html="";
      switch(currentStep){
        case 1: html=`<h3>${c.tutorialStep1Title}</h3><p>${c.tutorialStep1Content.replace(/\n/g,'<br>')}</p>`; break;
        case 2: html=`<h3>${c.tutorialStep2Title}</h3><p>${c.tutorialStep2Content.replace(/\n/g,'<br>')}</p>`; break;
        case 3: html=`<h3>${c.tutorialStep3Title}</h3><p>${c.tutorialStep3Content.replace(/\n/g,'<br>')}</p>`; break;
        case 4: html=`<h3>${c.tutorialStep4Title}</h3><p>${c.tutorialStep4Content.replace(/\n/g,'<br>')}</p>`; break;
        case 5: html=`<h3>${c.tutorialStep5Title}</h3><p>${c.tutorialStep5Content.replace(/\n/g,'<br>')}</p>`; break;
        case 6: html=`<h3>${c.tutorialStep6Title}</h3><p>${c.tutorialStep6Content.replace(/\n/g,'<br>')}</p>`; break;
        case 7: html=`<h3>${c.tutorialStep7Title}</h3><p>${c.tutorialStep7Content.replace(/\n/g,'<br>')}</p>`; break;
      }
      tutorialContent.innerHTML=html;
      document.getElementById('prev-button').style.display=currentStep===1?'none':'inline-block';
      document.getElementById('next-button').style.display=currentStep===totalSteps?'none':'inline-block';
    }
    window.onclick=function(e){ if(e.target==tutorialModal) closeTutorial(); };

    // ── START EVERYTHING ──
    initGame();
    updateLanguage();
    updateRunButton();
  </script>
</body>
</html>
